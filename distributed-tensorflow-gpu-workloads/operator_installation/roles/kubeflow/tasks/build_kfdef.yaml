---

# Remove any existing kfdef directories generated by this playbook
- name: If the Kubeflow build directory exists, delete it first
  file:
    state: absent
    path: '{{ kfdef_path }}'

# Create OpenShift kfdef directory where everything will be built
- name: Create or recreate Kubeflow build directory
  file:
    state: directory
    path: '{{ kfdef_path }}'

# Update the manifest repo URI
- name: Update the manifest repo URI
  lineinfile:
    path: '{{ odh_download_path }}/kfdef/kfctl_openshift.yaml'
    regexp: 'uri: .*'
    line: '    uri: {{ odh_download_path }}'

# Copy the OpenShift YAML file to the new directory we just created
- name: Copy kfctl_openshift.yaml to {{ kfdef_path }} to prepare for build
  shell: cp {{ odh_download_path }}/kfdef/kfctl_openshift.yaml {{ kfdef_path }}

# Build the deployment configuration before deployment
- name: Build kfdef deployment configuration
  shell: cd {{ kfdef_path }} && kfctl build --file=kfctl_openshift.yaml
